<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>マーカー管理サイト（地図プレビュー付き）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { margin:0; font-family: Arial; display:flex; height:100vh; }
#sidebar { width:350px; padding:10px; background:#f0f0f0; overflow-y:auto; box-sizing:border-box; }
#map { flex:1; min-width:400px; height:100vh; background:#ddd; }
h3 { margin:10px 0 5px 0; }
.list-item { cursor:pointer; padding:5px; border-bottom:1px solid #ccc; }
.selected { background:#e9e99b; }
label { display:block; margin-top:5px; }
input, select, textarea { width:100%; margin-top:2px; box-sizing:border-box; }
button { margin-top:5px; width:32%; }
#markerList, #typeList #labellist {
  max-height: 150px;  /* 上限5個分の高さの目安 */
  overflow-y: auto;   /* 上限を超えたらスクロール */
  border: 1px solid #ccc;
  padding: 5px;
}
.map-label {
  background: rgba(255,255,255,0.0); /* ラベルのCSS設定 */
  padding: 2px 4px;
  border-radius: 3px;
  font-size: 10px;
  text-align: center;
}
#markerPopup {
  position: absolute;
  background: white;
  border: 2px solid #333;
  border-radius: 8px;
  padding: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  display: none;
  max-width: 600px; /* ←ここがポップアップの横幅 */
  font-size: 14px;
  z-index: 9999;
}

  #markerPopup img {
  width: 100%; /* ←画像をポップアップ幅に合わせる */
  border-radius: 6px;
  margin-top: 5px;
}
</style>
</head>
<body>

<div id="sidebar">

  <button id="toggleOverlayBtn">dynmap表示切替</button>

  <h3>マーカー編集</h3>
  <label>X座標: <input type="number" id="markerX"></label>
  <label>Y座標: <input type="number" id="markerY"></label>
  <button id="selectCoordsBtn">座標選択</button>
  <label>名前<input id="markerName"/></label>
  <label>種類<select id="markerType"></select></label>
  <label>画像URL<input id="markerImage"/></label>
  <label>説明<textarea id="markerDesc"></textarea></label>
  <label>製作者名<input id="markerCreator"/></label>
  <label>住所<input id="markerAddress"/></label>
  <div>
    <button id="updateMarkerBtn">更新</button>
    <button id="addMarkerBtn">追加</button>
    <button id="deleteMarkerBtn">削除</button>
  </div>

  <h4>マーカー一覧</h4>
  <div id="markerList"></div>

  <h3>種類編集</h3>
  <label>名称<input id="typeName"/></label>
  <label>アイコンURL<input id="typeIcon"/></label>
  <label>説明<textarea id="typeDesc"></textarea></label>
  <div>
    <button id="updateTypeBtn">更新</button>
    <button id="addTypeBtn">追加</button>
    <button id="deleteTypeBtn">削除</button>
  </div>

  <h4>種類一覧</h4>
  <div id="typeList"></div>

  <h3>文字ラベル管理</h3>
  <label>ラベル名<input id="labelName"/></label>
  <label>X座標<input type="number" id="labelX"/></label>
  <label>Y座標<input type="number" id="labelY"/></label>
  <button id="selectLabelCoordsBtn">座標選択</button>
  <div>
    <button id="updateLabelBtn">更新</button>
    <button id="addLabelBtn">追加</button>
    <button id="deleteLabelBtn">削除</button>
  </div>

  <h4>ラベル一覧</h4>
  <div id="labelList"></div>

</div>

<!-- admin.html 内の map 以下から JS 部分 -->
<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"></script>

<!-- Supabase 用 URL と Key をブラウザで直接渡す -->
<script>
  window.__SUPABASE_URL__ = "https://あなたのプロジェクトID.supabase.co";
  window.__SUPABASE_ANON_KEY__ = "あなたのanon public key";
</script>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// --- Supabase 初期化（Vercel環境変数経由） ---
const supabaseUrl = window.__SUPABASE_URL__ || 'https://あなたのプロジェクトID.supabase.co';
const supabaseAnonKey = window.__SUPABASE_ANON_KEY__ || 'あなたのanon public key';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

// --- データ配列 ---
let markers = [], types = [], labels = [];
let selectedMarkerIndex = null, selectedTypeIndex = null, selectedLabelIndex = null;

// --- Leaflet 地図 ---
const map = L.map('map', { crs: L.CRS.Simple, minZoom:-5 });
const mapWidth = 5049, mapHeight = 2529;
const bounds = [[0,0],[mapHeight,mapWidth]];
map.setMaxBounds(bounds);
map.fitBounds(bounds);
L.imageOverlay('map.svg', bounds).addTo(map);
const markerLayer = L.layerGroup().addTo(map);
const labelLayer = L.layerGroup().addTo(map);

// --- データ取得 ---
async function loadData() {
  const { data: markersData } = await supabase.from('markers').select('*');
  const { data: typesData } = await supabase.from('type').select('*');
  const { data: labelsData } = await supabase.from('labels').select('*');

  markers = markersData || [];
  types = typesData || [];
  labels = labelsData || [];

  refreshMarkerList();
  refreshTypeList();
  refreshMarkerTypeSelect();
  refreshLabelList();
  drawMarkers();
  drawLabels();
}
await loadData();

// --- マーカー描画 ---
function drawMarkers() {
  markerLayer.clearLayers();
  markers.forEach((m,i)=>{
    const type=types.find(t=>t.name===m.type);
    const iconUrl=type?type.icon:'';
    const leafletIcon=iconUrl?L.icon({iconUrl,iconSize:[32,32],iconAnchor:[16,16]}):null;
    const popupContent = `
      <div style="min-width:150px;">
        <strong>${m.name}</strong><br>
        ${m.description ? `${m.description}<br>` : ''}
        ${m.image ? `<img src="${m.image}" alt="${m.name}" style="max-width:100%;"><br>` : ''}
        ${m.creator ? `製作者: ${m.creator}<br>` : ''}
      </div>
    `;
    const lm = L.marker([m.y, m.x], {icon: leafletIcon}).addTo(markerLayer);
    lm.bindPopup(popupContent);
  });
  if(selectedMarkerIndex!==null) showMarkerOnMap(markers[selectedMarkerIndex]);
}

// --- ラベル描画 ---
function drawLabels() {
  labelLayer.clearLayers();
  labels.forEach((l) => {
    L.marker([l.y, l.x], {
      icon: L.divIcon({ className: 'map-label', html: l.name, iconSize: [100, 24] }),
      interactive: false
    }).addTo(labelLayer);
  });
}

// --- リスト更新 ---
function refreshMarkerList() {
  const div = document.getElementById('markerList'); div.innerHTML='';
  markers.forEach((m,i)=>{
    const d = document.createElement('div');
    d.className = 'list-item'+(i===selectedMarkerIndex?' selected':'');
    d.textContent = m.name+' ('+m.type+')';
    d.onclick = ()=>selectMarker(i);
    div.appendChild(d);
  });
}
function refreshTypeList() {
  const div = document.getElementById('typeList'); div.innerHTML='';
  types.forEach((t,i)=>{
    const d = document.createElement('div');
    d.className = 'list-item'+(i===selectedTypeIndex?' selected':'');
    d.textContent = t.name;
    d.onclick = ()=>selectType(i);
    div.appendChild(d);
  });
}
function refreshMarkerTypeSelect(){
  const sel=document.getElementById('markerType'); sel.innerHTML='';
  types.forEach(t=>{
    const o=document.createElement('option');
    o.value=t.name; o.textContent=t.name;
    sel.appendChild(o);
  });
}
function refreshLabelList(){
  const div = document.getElementById('labelList'); div.innerHTML='';
  labels.forEach((l,i)=>{
    const d = document.createElement('div');
    d.className = 'list-item'+(i===selectedLabelIndex?' selected':'');
    d.textContent = `${l.name} (x:${l.x}, y:${l.y})`;
    d.onclick = ()=>selectLabel(i);
    div.appendChild(d);
  });
}

// --- 選択 ---
function selectMarker(i){
  selectedMarkerIndex = i;
  const m=markers[i];
  document.getElementById('markerX').value = m.x;
  document.getElementById('markerY').value = m.y;
  document.getElementById('markerName').value = m.name;
  document.getElementById('markerType').value = m.type;
  document.getElementById('markerDesc').value = m.description;
  document.getElementById('markerImage').value = m.image || '';
  document.getElementById('markerCreator').value = m.creator || '';
  refreshMarkerList();
  showMarkerOnMap(m);
}
function selectType(i){
  selectedTypeIndex=i;
  const t=types[i];
  document.getElementById('typeName').value=t.name;
  document.getElementById('typeIcon').value=t.icon;
  document.getElementById('typeDesc').value=t.description;
  refreshTypeList();
}
function selectLabel(i){
  selectedLabelIndex=i;
  const l=labels[i];
  document.getElementById('labelName').value=l.name;
  document.getElementById('labelX').value=l.x;
  document.getElementById('labelY').value=l.y;
  refreshLabelList();
}

// --- ボタン操作 ---
// マーカー
document.getElementById('addMarkerBtn').onclick = async ()=>{
  const newM={x:mapHeight/2,y:mapWidth/2,name:'',type:types[0]?types[0].name:'',description:''};
  markers.push(newM); selectedMarkerIndex=markers.length-1;
  selectMarker(selectedMarkerIndex);
  await saveMarkers(); refreshMarkerList(); drawMarkers();
};
document.getElementById('updateMarkerBtn').onclick = async ()=>{
  if(selectedMarkerIndex===null) return;
  const m=markers[selectedMarkerIndex];
  m.x=parseInt(document.getElementById('markerX').value);
  m.y=parseInt(document.getElementById('markerY').value);
  m.name=document.getElementById('markerName').value;
  m.type=document.getElementById('markerType').value;
  m.description=document.getElementById('markerDesc').value;
  m.image=document.getElementById('markerImage').value||'';
  m.creator=document.getElementById('markerCreator').value||'';
  await saveMarkers(); drawMarkers(); refreshMarkerList();
};
document.getElementById('deleteMarkerBtn').onclick = async ()=>{
  if(selectedMarkerIndex===null) return;
  const m=markers.splice(selectedMarkerIndex,1)[0];
  if(m.id) await supabase.from('markers').delete().eq('id',m.id);
  selectedMarkerIndex=null;
  drawMarkers(); refreshMarkerList();
};

// タイプ
document.getElementById('addTypeBtn').onclick = async ()=>{
  const newT={name:'',icon:'',description:''};
  types.push(newT); selectedTypeIndex=types.length-1;
  selectType(selectedTypeIndex);
  await saveTypes(); refreshTypeList(); refreshMarkerTypeSelect(); drawMarkers();
};
document.getElementById('updateTypeBtn').onclick = async ()=>{
  if(selectedTypeIndex===null) return;
  const t=types[selectedTypeIndex];
  t.name=document.getElementById('typeName').value;
  t.icon=document.getElementById('typeIcon').value;
  t.description=document.getElementById('typeDesc').value;
  await saveTypes(); refreshTypeList(); refreshMarkerTypeSelect(); drawMarkers();
};
document.getElementById('deleteTypeBtn').onclick = async ()=>{
  if(selectedTypeIndex===null) return;
  const t=types.splice(selectedTypeIndex,1)[0];
  if(t.id) await supabase.from('type').delete().eq('id',t.id);
  selectedTypeIndex=null;
  refreshTypeList(); refreshMarkerTypeSelect(); drawMarkers();
};

// ラベル
document.getElementById('addLabelBtn').onclick = async ()=>{
  const newL={name:document.getElementById('labelName').value,
              x:parseInt(document.getElementById('labelX').value),
              y:parseInt(document.getElementById('labelY').value)};
  labels.push(newL);
  await saveLabels(); refreshLabelList(); drawLabels();
};
document.getElementById('updateLabelBtn').onclick = async ()=>{
  if(selectedLabelIndex===null) return;
  const l={name:document.getElementById('labelName').value,
           x:parseInt(document.getElementById('labelX').value),
           y:parseInt(document.getElementById('labelY').value)};
  labels[selectedLabelIndex]=l;
  await saveLabels(); refreshLabelList(); drawLabels();
};
document.getElementById('deleteLabelBtn').onclick = async ()=>{
  if(selectedLabelIndex===null) return;
  const l=labels.splice(selectedLabelIndex,1)[0];
  await saveLabels(); refreshLabelList(); drawLabels();
};

// --- Supabase 保存関数 ---
async function saveMarkers() {
  for(const m of markers){
    if(m.id){
      const { error } = await supabase.from('markers').update(m).eq('id', m.id);
      if(error) console.error(error);
    } else {
      const { data, error } = await supabase.from('markers').insert([m]);
      if(error) console.error(error);
      else m.id = data[0].id;
    }
  }
}
async function saveTypes() {
  for(const t of types){
    if(t.id){
      const { error } = await supabase.from('type').update(t).eq('id', t.id);
      if(error) console.error(error);
    } else {
      const { data, error } = await supabase.from('type').insert([t]);
      if(error) console.error(error);
      else t.id = data[0].id;
    }
  }
}
async function saveLabels() {
  for(const l of labels){
    if(l.id){
      const { error } = await supabase.from('labels').update(l).eq('id', l.id);
      if(error) console.error(error);
    } else {
      const { data, error } = await supabase.from('labels').insert([l]);
      if(error) console.error(error);
      else l.id = data[0].id;
    }
  }
}

// --- マーカー選択で地図中央に ---
function showMarkerOnMap(m){
  map.setView([m.y, m.x], map.getZoom());
}
</script>
</body>
</html>
