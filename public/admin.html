<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>マーカー管理サイト（地図プレビュー付き）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
body { margin:0; font-family: Arial; display:flex; height:100vh; }
#sidebar { width:350px; padding:10px; background:#f0f0f0; overflow-y:auto; box-sizing:border-box; }
#map { flex:1; min-width:400px; height:100vh; background:#ddd; }
.list-item { cursor:pointer; padding:5px; border-bottom:1px solid #ccc; }
.selected { background:#e9e99b; }
button { margin-top:5px; width:32%; }
.map-label {
  background: rgba(255,255,255,0.0);
  font-size: 10px;
}
</style>
</head>
<body>

<div id="sidebar">
  <button id="toggleOverlayBtn">dynmap表示切替</button>
  <h3>マーカー編集</h3>
  <label>X座標<input type="number" id="markerX"></label>
  <label>Y座標<input type="number" id="markerY"></label>
  <button id="selectCoordsBtn">座標選択</button>
  <label>名前<input id="markerName"/></label>
  <label>種類<select id="markerType"></select></label>
  <label>画像URL<input id="markerImage"/></label>
  <label>説明<textarea id="markerDesc"></textarea></label>
  <label>製作者名<input id="markerCreator"/></label>
  <label>住所<input id="markerAddress"/></label>
  <div>
    <button id="updateMarkerBtn">更新</button>
    <button id="addMarkerBtn">追加</button>
    <button id="deleteMarkerBtn">削除</button>
  </div>

  <h4>マーカー一覧</h4>
  <div id="markerList"></div>

  <h3>種類編集</h3>
  <label>名称<input id="typeName"/></label>
  <label>アイコンURL<input id="typeIcon"/></label>
  <label>説明<textarea id="typeDesc"></textarea></label>
  <div>
    <button id="updateTypeBtn">更新</button>
    <button id="addTypeBtn">追加</button>
    <button id="deleteTypeBtn">削除</button>
  </div>

  <h4>種類一覧</h4>
  <div id="typeList"></div>

  <h3>文字ラベル管理</h3>
  <label>ラベル名<input id="labelName"/></label>
  <label>X座標<input type="number" id="labelX"></label>
  <label>Y座標<input type="number" id="labelY"></label>
  <button id="selectLabelCoordsBtn">座標選択</button>
  <div>
    <button id="updateLabelBtn">更新</button>
    <button id="addLabelBtn">追加</button>
    <button id="deleteLabelBtn">削除</button>
  </div>

  <h4>ラベル一覧</h4>
  <div id="labelList"></div>
</div>

<div id="map"></div>

<!-- Supabase接続と地図処理 -->
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// ===== Supabase初期化 =====
const supabaseUrl = 'https://YOUR_PROJECT_ID.supabase.co';
const supabaseAnonKey = 'YOUR_ANON_PUBLIC_KEY';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

// ===== Leaflet地図初期化 =====
const mapWidth = 5049, mapHeight = 2529;
const bounds = [[0,0],[mapHeight,mapWidth]];
const map = L.map('map', { crs:L.CRS.Simple, minZoom:-5 }).setView([mapHeight/2,mapWidth/2],0);
L.imageOverlay('map.svg', bounds).addTo(map);
map.setMaxBounds(bounds);

// ===== データ変数 =====
let markers = [], types = [], labels = [];
let selectedMarkerIndex = null, selectedTypeIndex = null, selectedLabelIndex = null;

// ===== Supabaseからデータ読み込み =====
async function loadData(){
  const { data: m } = await supabase.from('markers').select('*');
  const { data: t } = await supabase.from('type').select('*');
  const { data: l } = await supabase.from('labels').select('*');
  markers = m || []; types = t || []; labels = l || [];
  refreshMarkerList(); refreshTypeList(); refreshLabelList();
  drawMarkers(); drawLabels();
}
await loadData();

// ===== 保存関数 =====
async function saveMarkers(){
  for(const m of markers){
    if(m.id) await supabase.from('markers').update(m).eq('id',m.id);
    else { const { data } = await supabase.from('markers').insert([m]); if(data) m.id=data[0].id; }
  }
}

async function saveTypes(){
  for(const t of types){
    if(t.id) await supabase.from('type').update(t).eq('id',t.id);
    else { const { data } = await supabase.from('type').insert([t]); if(data) t.id=data[0].id; }
  }
}

async function saveLabels(){
  for(const l of labels){
    if(l.id) await supabase.from('labels').update(l).eq('id',l.id);
    else { const { data } = await supabase.from('labels').insert([l]); if(data) l.id=data[0].id; }
  }
}

// ===== 削除関数 =====
async function deleteMarker(id){
  await supabase.from('markers').delete().eq('id',id);
}
async function deleteType(id){
  await supabase.from('type').delete().eq('id',id);
}
async function deleteLabel(id){
  await supabase.from('labels').delete().eq('id',id);
}

// ===== 削除ボタン書き換え =====
document.getElementById('deleteMarkerBtn').onclick = async ()=>{
  if(selectedMarkerIndex===null) return;
  const id = markers[selectedMarkerIndex].id;
  if(id) await deleteMarker(id);
  markers.splice(selectedMarkerIndex,1);
  selectedMarkerIndex=null;
  refreshMarkerList(); drawMarkers();
};

document.getElementById('deleteTypeBtn').onclick = async ()=>{
  if(selectedTypeIndex===null) return;
  const id = types[selectedTypeIndex].id;
  if(id) await deleteType(id);
  types.splice(selectedTypeIndex,1);
  selectedTypeIndex=null;
  refreshTypeList(); refreshMarkerTypeSelect(); drawMarkers();
};

document.getElementById('deleteLabelBtn').onclick = async ()=>{
  if(selectedLabelIndex===null) return;
  const id = labels[selectedLabelIndex].id;
  if(id) await deleteLabel(id);
  labels.splice(selectedLabelIndex,1);
  selectedLabelIndex=null;
  refreshLabelList(); drawLabels();
};

// ===== 以降：描画・リスト更新関数はあなたの元コードのままでOK =====
</script>
</body>
</html>
